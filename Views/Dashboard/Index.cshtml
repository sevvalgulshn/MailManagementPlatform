@model Project2EmailNight.Models.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-1">Genel Bakış</h3>
            <div class="text-muted">Mail performans özeti</div>
        </div>

        <span class="badge bg-light text-dark px-3 py-2 shadow-sm">
            Son Güncelleme: @DateTime.Now.ToString("dd MMM yyyy")
        </span>
    </div>


    <div class="row g-3 mb-4">

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card stat-inbox">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Gelen Mesajlar</div>
                        <div class="stat-val">@Model.InboxCount</div>
                        <div class="stat-sub">Son 7 gün</div>
                        <div class="stat-bar mt-2"><span style="width:65%"></span></div>

                    </div>
                    <div class="stat-icon"><i class="mdi mdi-inbox-arrow-down-outline"></i></div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card stat-sent">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Giden Mesajlar</div>
                        <div class="stat-val">@Model.SentCount</div>
                        <div class="stat-sub">Son 7 gün</div>
                        <div class="stat-bar mt-2"><span style="width:65%"></span></div>

                    </div>
                    <div class="stat-icon"><i class="mdi mdi-send-outline"></i></div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card stat-unread">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Okunmamış</div>
                        <div class="stat-val">@Model.UnreadCount</div>
                        <div class="stat-sub">Son 7 gün</div>
                        <div class="stat-bar mt-2"><span style="width:65%"></span></div>

                    </div>
                    <div class="stat-icon"><i class="mdi mdi-email-alert-outline"></i></div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card stat-read">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Okunan</div>
                        <div class="stat-val">@Model.ReadCount</div>
                        <div class="stat-sub">Son 7 gün</div>
                        <div class="stat-bar mt-2"><span style="width:65%"></span></div>

                    </div>
                    <div class="stat-icon"><i class="mdi mdi-email-open-outline"></i></div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card stat-mine">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Benim Toplam</div>
                        <div class="stat-val">@Model.MyTotalCount</div>
                        <div class="stat-sub">Toplam</div>
                        <div class="stat-bar mt-2"><span style="width:65%"></span></div>

                    </div>
                    <div class="stat-icon"><i class="mdi mdi-account-check-outline"></i></div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card stat-total">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Sistem Toplam</div>
                        <div class="stat-val">@Model.TotalMessages</div>
                        <div class="stat-sub">Toplam</div>
                        <div class="stat-bar mt-2"><span style="width:65%"></span></div>

                    </div>
                    <div class="stat-icon"><i class="mdi mdi-database-outline"></i></div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card stat-cat">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Kategoriler</div>
                        <div class="stat-val">@Model.CategoryCount</div>
                        <div class="stat-sub">Aktif</div>
                        <div class="stat-bar mt-2"><span style="width:65%"></span></div>

                    </div>
                    <div class="stat-icon"><i class="mdi mdi-tag-multiple-outline"></i></div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card stat-user">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Kullanıcılar</div>
                        <div class="stat-val">@Model.UserCount</div>
                        <div class="stat-sub">Aktif</div>
                        <div class="stat-bar mt-2"><span style="width:65%"></span></div>

                    </div>
                    <div class="stat-icon"><i class="mdi mdi-account-group-outline"></i></div>
                </div>
            </div>
        </div>

    </div>


    <!-- Grafik + Liste -->
    <div class="row g-3">
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="mb-3">Kategoriye Göre Mesaj Dağılımı</h6>

                    @if (Model.CategoryCounts == null || !Model.CategoryCounts.Any())
                    {
                        <div class="text-muted">Henüz kategori mesajı yok.</div>
                    }
                    else
                    {
                        <div class="chart-wrap">
                            <canvas id="catChart"></canvas>
                        </div>


                    }
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="mb-3">Kategoriler</h6>

                    @if (Model.CategoryCounts == null || !Model.CategoryCounts.Any())
                    {
                        <div class="text-muted">Henüz veri yok.</div>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var c in Model.CategoryCounts)
                            {
                                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                   asp-controller="Message"
                                   asp-action="Inbox"
                                   asp-route-categoryId="@c.CategoryId">
                                    <div class="d-flex align-items-center gap-2">
                                        <span style="width:10px;height:10px;border-radius:50%;background:@(c.ColorHex ?? "#94a3b8");display:inline-block;"></span>
                                        <span>@c.CategoryName</span>
                                    </div>
                                    <span class="badge bg-light text-dark">@c.Count</span>
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .stat-card {
        border-radius: 18px;
        border: 0;
        box-shadow: 0 10px 25px rgba(15, 23, 42, .06);
        transition: transform .15s ease, box-shadow .15s ease;
        background: #fff;
        position: relative;
        overflow: hidden;
    }

        .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, currentColor, transparent);
            opacity: .6;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 45px rgba(15, 23, 42, .12);
        }

    .stat-label {
        font-size: .92rem;
        color: #64748b;
        font-weight: 600;
    }

    .stat-val {
        font-size: 28px;
        font-weight: 800;
        margin-top: 2px;
        letter-spacing: -.02em;
    }

    .stat-sub {
        font-size: .82rem;
        color: #94a3b8;
        margin-top: 2px;
    }

    /* Icon badge */
    .stat-icon {
        width: 46px;
        height: 46px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        font-size: 22px;
        box-shadow: 0 10px 22px rgba(15,23,42,.10);
    }

    /* Her karta farklı tema  */
    .stat-inbox .stat-icon {
        background: rgba(59, 130, 246, .12);
        color: #3b82f6;
    }

    .stat-sent .stat-icon {
        background: rgba(16, 185, 129, .12);
        color: #10b981;
    }

    .stat-unread .stat-icon {
        background: rgba(249, 115, 22, .12);
        color: #f97316;
    }

    .stat-read .stat-icon {
        background: rgba(99, 102, 241, .12);
        color: #6366f1;
    }

    .stat-mine .stat-icon {
        background: rgba(236, 72, 153, .12);
        color: #ec4899;
    }

    .stat-total .stat-icon {
        background: rgba(14, 165, 233, .12);
        color: #0ea5e9;
    }

    .stat-cat .stat-icon {
        background: rgba(168, 85, 247, .12);
        color: #a855f7;
    }

    .stat-user .stat-icon {
        background: rgba(34, 197, 94, .12);
        color: #22c55e;
    }
    /* Kartın kendisine renk veriyoruz (progress bar için gerekli) */
    .stat-inbox {
        color: #3b82f6;
    }

    .stat-sent {
        color: #10b981;
    }

    .stat-unread {
        color: #f97316;
    }

    .stat-read {
        color: #6366f1;
    }

    .stat-mine {
        color: #ec4899;
    }

    .stat-total {
        color: #0ea5e9;
    }

    .stat-cat {
        color: #a855f7;
    }

    .stat-user {
        color: #22c55e;
    }


    /* Analytics kartları */
    .card.shadow-sm {
        border: 0;
        border-radius: 18px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, .06) !important;
    }

    /* Doughnut daha küçük + ortalı */
    .chart-wrap {
        max-width: 360px;
        height: 220px;
        margin: 0 auto;
    }
    /* mini progress bar----sonradan kaldırablirsin dee */
    .stat-bar {
        height: 6px;
        border-radius: 999px;
        background: #eef2ff;
        overflow: hidden;
    }

        .stat-bar span {
            display: block;
            height: 100%;
            border-radius: 999px;
            background: currentColor; /* kart temasıyla aynı rengi alır */
            opacity: .85;
        }

</style>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    @if (Model.CategoryCounts != null && Model.CategoryCounts.Any())
    {
        <script>
            const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.CategoryCounts.Select(x => x.CategoryName)));
            const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.CategoryCounts.Select(x => x.Count)));
            const colors = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.CategoryCounts.Select(x => x.ColorHex ?? "#94a3b8")));

            const ctx = document.getElementById('catChart').getContext('2d');

            new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: labels,
                datasets: [{
                  data: data,
                  backgroundColor: colors,
                  borderWidth: 0
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                cutout: '78%'
              },
              plugins: [{
                id: 'centerText',
                beforeDraw(chart) {
                  if (!chart.chartArea) return;

                  const { ctx, chartArea } = chart;
                  const centerX = (chartArea.left + chartArea.right) / 2;
                  const centerY = (chartArea.top + chartArea.bottom) / 2;

                  const total = chart.data.datasets[0].data
                    .map(Number)
                    .reduce((a, b) => a + b, 0);

                  ctx.save();
                  ctx.font = "800 22px sans-serif";
                  ctx.fillStyle = "#1e293b";
                  ctx.textAlign = "center";
                  ctx.textBaseline = "middle";
                  ctx.fillText(total, centerX, centerY);
                  ctx.restore();
                }
              }]
            });
        </script>

    }
}
